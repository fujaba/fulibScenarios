# Workflow

The following steps describe a usual workflow with a source generator:

1. the user writes the code in the source language \(e.g. scenario\)
2. the user runs the tool, which generates the initial set of source files \(i.e. `Person.java`\).
3. the tool also saves a copy of this file, with the header shown below \(i.e. `Person.java.base`\)
4. the user edits `Person.java` \(the previous examples called this file `Person_edited.java`, but it is still the same file\).
5. the user edits the code of the source language.
6. the user runs the tool again, which \(internally\) generates `Person_newgen.java`.
7. the tool detects the existence of `Person.java.base` and the \(edited\) `Person.java` and creates a copy of `Person.java.base` without the header \(call this file `Person.java.base_without_header`\).
8. the tool runs `diff3 -m Person.java Person.java.base_without_header Person_newgen.java` and writes the result into `Person.java`.
9. the tool saves `Person_newgen.java` into `Person.java.base` with the header below.
10. go back to step 4

The following header is prepended to the `.base` files:

```text
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
DO NOT EDIT THIS FILE - IT IS USED FOR THREE-WAY MERGE AND MUST NOT BE EDITED!!!
```

{% hint style="info" %}
The header is designed to be 80x24, which is the default size of a terminal. It is meant to discourage users from editing the file, because that interferes with the merge progress.

Originally, it was planned to save a `.gz` file containing the original, but that does not play well with version control systems.
{% endhint %}

An example implementation of such a tool \(in bash\) is shown below:

{% code title="tool.sh" %}
```bash
#!/usr/bin/env bash
input="src/Person.mylang"
base="src/Person.java.base"
output="src/Person.java"

mkdir -p temp
merged="temp/Person_merged.java"
newgen="temp/Person_newgen.java"
tempbase="temp/Person.java.base_without_header"

# step 6
# simple source generator - just copy the content
cat "$input" >"$newgen"

if [[ -f "$output" ]]
then
	# step 7
	tail -n+25 "$base" >"$tempbase"
	# step 8
	diff3 -m \
	--label='edited source' "$output" \
	--label='base' "$tempbase" \
	--label='new generated source' "$newgen" \
	>"$merged" # using temp file because we cannot write into the file we are reading
	cat "$merged" >"$output"
	# step 9
	cat "header.txt" "$newgen" >"$base"
else # first invocation, output and base do not exist
	# step 2
	cat "$newgen" >"$output"
	# step 3
	cat "header.txt" "$newgen" >"$base"
fi
```
{% endcode %}

